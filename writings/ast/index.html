<!DOCTYPE html>
<html date="2022-06-30" data-theme="light">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>WATERSTOPPER | Ast</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/colors.css">
    <link rel="stylesheet" href="/css/writing.css">

    <link rel="icon" type="image/svg+xml" href="/resources/avatar.svg">
    <script type="text/javascript">
        function preLoadFunc() {
let theme = localStorage.getItem("theme") ?? "light";
            document.documentElement.setAttribute("data-theme", theme);
        }
        window.onload = preLoadFunc;
    </script>
    
</head>

<body>
    <h1 style="text-align: center;">Ast</h1>
<p>Abstract Syntax Tree (AST) is key concept in program evaluation. It
is a tree with tokens as its nodes. Tree is a better structure than
sequence. Here is why:</p>
<ol type="1">
<li>Operator precedence.</li>
<li>Hierarchy</li>
</ol>
<h3 id="operator-precedence">Operator precedence</h3>
<p>Consider a following expression : 5 + 7 * 2 + 3. It is obvious to us
humans which arithmetic operator. we should calculate first. But it is
not that simple for a machine. Hence, we introduce a tree structure:</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   width="69.188545mm"
   height="89.817238mm"
   viewBox="0 0 69.188545 89.817238"
   version="1.1"
   id="svg8"
   inkscape:version="1.0.2-2 (e86c870879, 2021-01-15)"
   sodipodi:docname="ast_arithmetic.svg">
  <defs
     id="defs2" />
  <sodipodi:namedview
     id="base"
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1.0"
     inkscape:pageopacity="0.0"
     inkscape:pageshadow="2"
     inkscape:zoom="1.4"
     inkscape:cx="103.33721"
     inkscape:cy="193.47371"
     inkscape:document-units="mm"
     inkscape:current-layer="layer1"
     inkscape:document-rotation="0"
     showgrid="false"
     inkscape:window-width="1920"
     inkscape:window-height="1001"
     inkscape:window-x="-9"
     inkscape:window-y="-9"
     inkscape:window-maximized="1" />
  <metadata
     id="metadata5">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title></dc:title>
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g
     inkscape:label="Layer 1"
     inkscape:groupmode="layer"
     id="layer1"
     transform="translate(-35.715768,-21.54733)">
    <path
       style="fill:var(--main-color);stroke-width:0.264583"
       d="m 37.920079,110.95554 c -0.09644,-0.25131 -0.05473,-0.9088 0.09268,-1.46108 0.25731,-0.96402 0.240647,-1.00735 -0.416909,-1.08398 -0.401254,-0.0468 -0.721363,-0.27192 -0.772896,-0.54364 -0.089,-0.46929 0.05531,-0.56134 1.307203,-0.83376 0.541491,-0.11783 0.75328,-0.38233 0.960824,-1.19999 0.146423,-0.57686 0.200964,-1.1141 0.1212,-1.19387 -0.334528,-0.33452 -2.00012,-0.12143 -2.304504,0.29485 -0.478171,0.65393 -1.191909,0.25629 -1.191909,-0.66405 0,-0.98973 1.074497,-1.49065 2.703523,-1.26034 0.623115,0.0881 1.452531,0.1592 1.843146,0.15801 0.390618,-10e-4 0.780095,0.11091 0.865508,0.24911 0.08541,0.1382 -0.04816,0.98304 -0.296813,1.87742 -0.354853,1.27633 -0.385439,1.73289 -0.142192,2.12239 0.386569,0.619 0.145299,1.31092 -0.45711,1.31092 -0.310875,0 -0.577575,0.39661 -0.844336,1.25561 -0.407651,1.31266 -1.148469,1.80358 -1.467419,0.9724 z m 35.366526,-1.78971 c 0,-0.41922 0.429987,-0.98262 1.327581,-1.73948 1.878179,-1.5837 3.01091,-4.09638 2.100365,-4.65913 -0.412525,-0.25496 -1.507905,0.56351 -1.982536,1.48134 -0.51154,0.98921 -1.277019,0.94967 -1.395367,-0.0721 -0.167619,-1.44714 1.42394,-2.85727 3.224905,-2.85727 2.140017,0 2.677766,2.80007 0.995974,5.18604 l -0.830019,1.17756 0.678021,0.25778 c 0.956839,0.36379 1.067949,0.33853 1.820405,-0.41393 0.551487,-0.55149 0.766744,-0.62085 1.20265,-0.38756 0.765218,0.40953 0.658207,0.89271 -0.404312,1.82562 -1.062294,0.93271 -1.625772,0.99824 -3.396197,0.395 -1.14994,-0.39183 -1.28865,-0.39183 -1.721612,0 -0.730284,0.6609 -1.619858,0.55443 -1.619858,-0.19388 z M 40.654662,97.967811 c -0.544364,-0.544361 0.236445,-1.368253 4.519964,-4.769358 2.582995,-2.050891 4.923166,-3.979754 5.200383,-4.286364 0.69588,-0.769667 1.480346,-0.733747 1.480346,0.06778 0,0.745808 -1.318736,2.021499 -5.376619,5.201124 -1.574694,1.233879 -3.347021,2.630368 -3.938505,3.103311 -1.06472,0.851334 -1.544005,1.025073 -1.885569,0.683507 z m 33.425693,-2.088644 c -0.800365,-0.641956 -2.110053,-1.611191 -2.910417,-2.153854 -3.186105,-2.160246 -4.620067,-4.047779 -3.075104,-4.047779 0.345982,0 0.786209,0.189352 0.978281,0.420786 0.192069,0.231431 1.129382,0.973653 2.082916,1.649386 0.953535,0.67573 1.971824,1.44898 2.262865,1.718334 0.291042,0.269353 0.826823,0.647594 1.190625,0.840533 1.05237,0.55812 2.204747,1.903548 2.027047,2.366624 -0.259609,0.676532 -1.015521,0.441725 -2.556213,-0.79403 z m 25.353892,-8.631772 c -1.085294,-0.288902 -1.483529,-0.916118 -0.931904,-1.467742 0.294177,-0.294177 0.593775,-0.306578 1.555617,-0.06438 1.5378,0.387223 3.01899,-0.147211 3.27898,-1.183111 0.25943,-1.033637 -0.31397,-1.552702 -1.53439,-1.389009 -0.80629,0.108146 -1.061,0.03427 -1.27768,-0.370591 -0.22501,-0.420434 -0.0906,-0.676953 0.79764,-1.521878 0.58754,-0.558917 1.06644,-1.123943 1.06421,-1.255615 -0.0147,-0.869765 -1.36359,-1.479148 -2.441975,-1.10322 -0.400936,0.139766 -0.728975,0.361537 -0.728975,0.492824 0,0.131283 -0.297656,0.238699 -0.661458,0.238699 -0.940099,0 -0.901118,-1.095373 0.06615,-1.858727 0.608957,-0.480582 0.982096,-0.555998 2.288288,-0.462497 1.35085,0.0967 1.66211,0.225245 2.3151,0.956064 0.78388,0.877313 0.95149,1.825476 0.47881,2.708677 -0.22628,0.422815 -0.14342,0.628687 0.46302,1.150323 0.63123,0.542963 0.73863,0.834184 0.73863,2.002872 0,1.204183 -0.10102,1.457794 -0.84579,2.123245 -0.80192,0.716513 -2.38979,1.345136 -3.25525,1.288722 -0.21828,-0.01423 -0.834338,-0.142322 -1.369019,-0.284652 z M 56.529661,84.209478 c -0.371281,-0.371279 -0.146325,-1.020061 0.632196,-1.823291 l 0.808585,-0.834248 -0.789458,-0.327003 c -1.028581,-0.426054 -1.725991,-1.21212 -1.529565,-1.724004 0.212612,-0.554056 0.927495,-0.509154 1.965018,0.123425 1.171509,0.714269 1.477312,0.676709 1.268371,-0.155781 -0.259213,-1.032783 0.05148,-1.697292 0.793586,-1.697292 0.559186,0 0.643628,0.121494 0.643628,0.926042 0,0.509323 0.06983,0.926042 0.155183,0.926042 0.08535,0 0.667904,-0.368208 1.294559,-0.818238 0.973439,-0.699071 1.222912,-0.773527 1.712976,-0.511251 0.771704,0.413004 0.598336,0.76223 -0.851612,1.715465 -0.673166,0.442556 -1.230426,0.864881 -1.238356,0.938499 -0.0079,0.07362 0.313005,0.283104 0.713187,0.465526 1.27394,0.580726 2.013286,1.284819 1.835542,1.748018 -0.222957,0.581017 -1.044343,0.542512 -2.09373,-0.09815 L 60.98348,82.534366 60.849487,83.26168 c -0.09235,0.501253 -0.319387,0.753707 -0.730464,0.812236 -0.481613,0.06857 -0.62779,-0.07169 -0.75913,-0.728374 l -0.162657,-0.813295 -1.025869,0.926809 c -1.039077,0.938744 -1.323414,1.068716 -1.641706,0.750422 z m 6.35,-13.758333 c -0.651552,-0.65155 0.269359,-1.754487 2.734027,-3.274426 0.800365,-0.493577 2.288646,-1.512641 3.307292,-2.264582 2.347587,-1.732938 3.42452,-2.275009 4.314785,-2.171837 1.2446,0.14424 1.048009,0.939678 -0.383942,1.553482 -0.697246,0.298876 -1.747859,0.931617 -2.334697,1.406091 -1.326573,1.072574 -7.01616,4.927661 -7.272559,4.927661 -0.103685,0 -0.267894,-0.07937 -0.364906,-0.176389 z m 32.44897,-2.27779 c -3.216981,-2.056025 -6.960777,-5.372942 -6.960777,-6.167091 0,-0.507479 0.137972,-0.639146 0.669761,-0.639146 0.368371,0 0.729554,0.155807 0.802629,0.346241 0.208582,0.543555 3.708414,3.386193 6.398964,5.197377 1.657887,1.116029 2.447396,1.810563 2.447396,2.152981 0,0.862544 -1.051499,0.58374 -3.357973,-0.890362 z M 36.821635,58.709111 c -0.43435,-0.176258 -0.589137,-0.423746 -0.529166,-0.846082 0.07474,-0.526354 0.217974,-0.588537 1.21113,-0.525793 1.04888,0.06626 1.155999,0.009 1.557046,-0.831977 0.739188,-1.550096 -0.17554,-3.340225 -1.706803,-3.340225 -1.444752,0 -1.656855,-0.40918 -1.577501,-3.043237 0.06755,-2.242217 0.106357,-2.38564 0.667035,-2.465269 0.327422,-0.0465 0.595313,0.02681 0.595313,0.16291 0,0.148862 0.448035,0.160787 1.124479,0.02993 1.994368,-0.385818 3.325974,-0.294479 3.616328,0.248052 0.388858,0.726585 -0.148342,1.098867 -1.585651,1.098867 -0.68031,0 -1.608997,0.07441 -2.06375,0.165365 -0.748072,0.149614 -0.826823,0.259024 -0.826823,1.148744 0,0.915813 0.07174,1.004874 1.044139,1.296212 3.457252,1.035818 3.366862,6.403369 -0.118097,7.012824 -0.436563,0.07635 -1.070017,0.0267 -1.407679,-0.110318 z m 42.980937,-1.186103 c -0.09128,-0.237877 -0.167791,-0.928781 -0.170018,-1.535343 -0.0021,-0.60656 -0.09153,-1.230633 -0.198438,-1.386827 -0.106913,-0.156194 -0.908762,-0.394319 -1.781887,-0.529167 -1.329385,-0.205314 -1.5875,-0.331216 -1.5875,-0.774345 0,-0.456607 0.202388,-0.539861 1.475994,-0.607163 l 1.475994,-0.078 -0.119663,-1.442955 c -0.129685,-1.563849 0.184888,-2.23751 1.044835,-2.23751 0.607525,0 0.92126,0.669139 0.533053,1.136901 -0.253794,0.3058 -0.03882,2.132063 0.289634,2.460514 0.06375,0.06375 0.818301,0.203647 1.676781,0.310883 1.435759,0.179345 1.560872,0.247904 1.560872,0.855316 0,0.631994 -0.06418,0.65822 -1.494972,0.610875 l -1.494975,-0.04947 0.03977,1.769258 c 0.03634,1.61667 -0.0087,1.776172 -0.521872,1.849395 -0.331266,0.04727 -0.629713,-0.09727 -0.727604,-0.352369 z m -41.52916,-15.38228 c -0.09701,-0.09701 -0.17639,-0.445196 -0.17639,-0.773737 0,-0.743873 4.46165,-4.944409 7.072437,-6.658531 0.985107,-0.646776 2.35513,-1.589691 3.044494,-2.095368 1.344187,-0.986014 2.142352,-1.062058 2.258221,-0.215146 0.05596,0.409013 -0.702722,1.057703 -3.400742,2.907713 -1.910022,1.309688 -4.556122,3.423047 -5.880222,4.696355 -2.427438,2.33432 -2.597523,2.458989 -2.917798,2.138714 z m 38.055901,-0.774473 c -0.436563,-0.521721 -2.579688,-2.158319 -4.7625,-3.636882 -2.880963,-1.951467 -3.96875,-2.832342 -3.96875,-3.21384 0,-1.057597 0.992061,-0.675006 4.705281,1.814606 4.310187,2.889862 5.83538,4.287367 5.702191,5.224804 -0.133998,0.943139 -0.79103,0.86918 -1.676222,-0.188688 z M 56.787114,30.477014 c -0.07204,-0.254662 -0.211926,-1.099926 -0.310853,-1.878364 l -0.179875,-1.415343 -1.889786,0.09243 c -1.790406,0.08757 -1.894229,0.06114 -1.974279,-0.50246 -0.105074,-0.739798 0.77211,-1.124905 2.56227,-1.124905 h 1.252702 l -0.01315,-2.050521 c -0.01294,-2.014342 -0.0016,-2.050521 0.648301,-2.050521 0.720082,0 0.71779,-0.0077 0.765624,2.579687 l 0.02812,1.521355 h 1.860386 c 1.445067,0 1.895912,0.09257 2.019509,0.414659 0.169688,0.442205 -0.251531,1.015546 -0.781198,1.063324 -0.176316,0.0159 -0.897808,0.04705 -1.603322,0.06922 l -1.282748,0.0403 0.187982,1.619667 c 0.143745,1.238518 0.103161,1.673408 -0.172458,1.848032 -0.566971,0.359214 -0.974919,0.276489 -1.117225,-0.226553 z"
       id="path847" />
  </g>
</svg>
</p>
<p>Now we need to recursively evaluate each child before calculating the
result of the overall expression.</p>
<h3 id="hierarchy">Hierarchy</h3>
<p>Let’s look at the following python code:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> some_method():</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SomeClass:</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    field <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    other <span class="op">=</span> <span class="st">&quot;other&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> class_method(<span class="va">self</span>):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> other_one(<span class="va">self</span>):</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;not classMethod&quot;</span></span></code></pre></div>
<p>Here is a sketch of AST representation:</p>
<pre><code>some_method:
    type: function
    children:
        params: ...
        body: ...
SomeClass:
    type: class
    children:
        field:
            type: variable
            children:
                value: ...
        other:
            type: variable
            children:
                value: ...
        class_method:
            type: function
            children:
                params: ...
                body: ...
         other_one:
            type: function
            children:
                params: ...
                body: ...
        </code></pre>
<p>Notice how all the functions of class are on the same level. We could
even add <code>fields</code> and <code>functions</code> and
<code>classes</code> nodes to separate statements of different
kinds:</p>
<pre><code>functions:
    some_method:
        ...
classes:
    SomeClass:
        type: class
        children:
            fields:
                field:
                    ...
                other:
                   ...
            functions:
                class_method:
                    ...
                 other_one:
                    ...</code></pre>
<p>This hierarchical structure is predictable and manageable.</p>
<h3 id="node-structure">Node structure</h3>
<p>AST trees do not have a commonly accepted structure. It’s content
varies depending on usage. But I found some general structure of AST
node. Nodes usually include.</p>
<ul>
<li>node type (declaration of class, method, variable, infix operator,
block etc)</li>
<li>node value: e.g. name of a particular identifier</li>
<li>children: nodes that a re children of the current one</li>
<li>meta information: position in the initial file, path to initial
file…</li>
</ul>
<h1 id="creating-ast">Creating AST</h1>
<p>A pipeline consists of two steps:</p>
<p><code>Code (text) -&gt; Tokens -&gt; CST</code><a href="#fn1"
class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a><code>-&gt; AST</code></p>
<p>To create tokens from code, a tokenizer (aka Lexer) is used. Usually
it’s pretty straightforward: read until next whitespace, identify
obtained token.</p>
<p>To create AST from tokens, we need a parser. I won’t go into much
detail here, because parsers are complicated enough for a separate <a
href="programming/parsers">post</a>.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Some parsers create an intermediate representation of
AST called concrete syntax tree. The difference between AST and CST is
that each AST node has a semantic purpose, while CST may contain
detrimental tokens that are used to make parsing of a grammar work.
Example of CST generated probably with a parser based on EBNF arithmetic
<a href="programming/introduction-to-grammars">grammar</a>: <img
src="/images/cst.png" alt="cst.png" /> <code>Expr</code>,
<code>Term</code> and <code>Factor</code> nodes do not have a semantic
purpose, therefore technically it is not an AST.<a href="#fnref1"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

    <p style="text-align: center; font-size: large;"><a href="/">Main</a> | <a href="/writings">Writings</a> | <a href="/drawings">Drawings</a></p>
    <div style="text-align: center;">꧁༻ ༺꧂</div>
</body>
</html>